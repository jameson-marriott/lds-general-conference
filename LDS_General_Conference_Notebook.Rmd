---
title: "LDS Text Analysis"
author: "Jameson Marriott"
output:
  html_notebook:
    code_folding: hide
---

This notebook is for trying out some text analysis on general conference talks from lds.org.

```{r startup, include=FALSE}
library(tidyverse)
library(stringr)
library(tidytext)
library(rvest)
library(furrr)
library(svMisc)
```

```{r download}
conference_year_links <- read_html("https://www.lds.org/general-conference/conferences?lang=eng") %>%
  html_nodes(".year-line__link") %>%
  html_attr("href") %>%
  str_c("https://www.lds.org", ., sep = "")
#head(conference_year_links)

# Pull down all the pages that list the conference talks during that year-month
conference_year_pages <- conference_year_links %>%
  future_map(read_html)
#head(conference_year_pages)
```

```{r prepare}
# Get the links to the individual talks
conference_talk_links <- conference_year_pages %>%
  future_map(html_nodes, css = ".lumen-tile__link") %>%
  future_map(html_attr, name = "href") %>%
  future_map( ~ paste0("https://www.lds.org", .)) %>% # This puts link in the empty last spot
  flatten_chr()
conference_talk_links <- conference_talk_links[1:length(conference_talk_links) - 1] # this removes the last link
#head(conference_talk_links)

# Get the titles of the individual talks
conference_talk_titles <- conference_year_pages %>%
  future_map(html_nodes, css = "div.lumen-tile__title") %>%
  #map(html_children) %>% # Not all titles have children, so this skips some of them
  future_map(html_text) %>%
  future_map(str_replace_all, pattern = "[^a-zA-Z0-9\\s:-]|\\t|\\n", replacement = "") %>%
  flatten_chr()
#head(conference_talk_titles)

# Get the authors of the individual talks
conference_talk_authors <- conference_year_pages %>%
  future_map(html_nodes, css = ".lumen-tile__content") %>%
  future_map(html_text) %>%
  flatten_chr()
#head(conference_talk_authors)

# Get the date from the hyperlink
conference_talk_date <- conference_talk_links %>%
  future_map_chr(substr, 40, 46) %>%
  future_map_chr(str_replace, "/", "-")

# Combine the data into a tibble
conference_talks <- tibble(Title = conference_talk_titles,
                           Author = conference_talk_authors,
                           Date = conference_talk_date,
                           Link = conference_talk_links)

#write_csv(conference_talks, "Conference Talks.csv")

conference_talks <- read_csv("Conference Talks.csv")
```


```{r talk_text_2}
# Initialize tibble
conf_text <- tibble(Link = conference_talks$Link, Text = "")
# Replace the table with a previously saved file if it available
try(
  conf_text <- read_csv("Conference Talk Text.csv") %>%
    rename(Link = link, Text = text)
)

# Scrape any websites that weren't saved already
for (i in seq_along(conf_text$Link)) {
  progress(i)
  if (is.na(conf_text[i,2]) | conf_text[i,2] == "") {
    conf_text[i,2] = as.character(conf_text[i,1]) %>%
      read_html() %>%
      html_nodes(css = "div.body-block") %>%
      html_text()
    Sys.sleep(sample(seq(1, 3, by=0.001), 1))
  }
  # Print the progress
}

# Write the latest version of the scraped text
# write_csv(conf_text %>% rename(Link = link, Text = text), paste(Sys.Date(), "Conference Talk Text.csv"))

```

```{r load_downloaded_data}
conference_talks <- read_csv("Conference Talks.csv") %>%
  left_join(read_csv("Conference Talk Text.csv") %>% rename(Link = link, Text = text))

```


Who have authored the most conference talks on lds.org?

```{r analyze}
# Who has the most conference talks on lds.org?
conference_talks %>%
  group_by(Author) %>%
  summarise(`Number of Talks` = n()) %>%
  arrange(desc(`Number of Talks`)) %>%
  top_n(12, `Number of Talks`)
```

What are the most common conference talk titles on lds.org, excluding "Statistical Report", etc.?

```{r}
# What are the most common conference talk titles on lds.org?
conference_talks %>%
  filter(!str_detect(.$Title, pattern = "Church Officers|Statistical Report|Church Audit")) %>% # This does remove a few more talks than ideal, but it's pretty close
  group_by(Title) %>%
  summarise(`Number of Talks` = n()) %>%
  arrange(desc(`Number of Talks`)) %>%
  top_n(10, `Number of Talks`)
```

What are the most common words in conference talk titles, once the reports and sustainings have been removed?

```{r}
conference_talks %>%
  filter(!str_detect(.$Title, pattern = "Church Officers|Statistical Report|Church Audit")) %>% # This does remove a few more talks than ideal, but it's pretty close
  unnest_tokens(word, Title) %>%
  anti_join(stop_words) %>%
  group_by(word) %>%
  summarise(count = n()) %>%
  arrange(desc(count)) %>%
  filter(!str_detect(.$word, "ye")) %>%
  top_n(12, count)

# I still need to pull in the content of the talks, but just downloading that will take some time.
# It would probably be a good idea to only pull down the talks from a couple of authors to start with. 

```

How do the word choices of the three most recent presidents of the LDS church compare? 

```{r}
tidy_conference <- conference_talks %>%
  mutate(Text = str_replace_all(Text, pattern = "[:digit:]|[:punct:]", replacement = " ")) %>%
  unnest_tokens(word, Text) %>%
  anti_join(stop_words)

tidy_presidents <- tidy_conference %>%
  dplyr::filter(Author == "Thomas S. Monson" | Author == "Gordon B. Hinckley" | Author == "Russell M. Nelson")

president_frequency <- tidy_presidents %>%
  count(Author, word) %>%
  group_by(Author) %>%
  mutate(Proportion = n/ sum(n))
president_frequency %>%
  group_by(Author) %>%
  top_n(n = 10, wt = Proportion) %>%
  arrange(Author, desc(Proportion))
  
president_frequency %>%
  group_by(Author) %>%
  top_n(n = 10, wt = Proportion) %>%
  #arrange(desc(Proportion)) %>%
  mutate(word = reorder(as.factor(word), Proportion)) %>%
  ggplot(aes(word, Proportion)) +
  geom_col() +
  ggtitle("Most Used Words from General Conference") +
  facet_grid(.~Author, scales = "free") +
  xlab(NULL) +
  coord_flip() 
  
```

How have the word length and the number of words per talk changed over the years? 

```{r}
tidy_conference_all <- conference_talks %>%
  filter(!str_detect(.$Title, pattern = "Church Officers|Statistical Report|Church Audit|Church Finance")) %>% # This does remove a few more talks than ideal, but it's pretty close
  mutate(Text = str_replace_all(Text, pattern = "[:digit:]|[:punct:]", replacement = " ")) %>%
  unnest_tokens(word, Text)

# Plotting the averages is not as interesting as seeing all of the points. 
#tidy_conference_summary <- tidy_conference_all %>%
#  mutate(word_length = str_length(word)) %>%
#  group_by(Date, Title) %>%
#  #group_by(Title) %>%
#  summarise(word_count = n(), word_length = sum(word_length)) %>%
#  ungroup() %>%
#  drop_na() %>%
#  group_by(Date) %>%
#  summarise(`Average Words/Talk` = mean(word_count),
#            #`Median Words/Talk` = median(word_count),
#            word_count = sum(word_count),
#            sum_word_length = sum(word_length)) %>%
#  ungroup() %>%
#  mutate(Date = as.numeric(str_replace(Date, "-", ".")),
#         `Average Word Length` = sum_word_length/word_count) %>%
#  select(-sum_word_length, -word_count) %>%
#  gather(key = Type, value = Value, -Date)
#
#ggplot(tidy_conference_summary, aes(Date, Value)) +
#  geom_point() +
#  geom_smooth(method = "lm", se = FALSE) +
#  facet_grid(Type ~ ., scales = "free") +
#  theme_bw() +
#  theme(axis.title.y = element_blank()) +
#  ggtitle("LDS General Conference Averages")
#
#ggsave("General Conference Talk Word Count and Length.jpg", width = 7, height = 5, units = "in", dpi = 300)

# Summarize each conference talk by length and word length
tidy_conference_distr <- tidy_conference_all %>%
  mutate(word_length = str_length(word)) %>%
  group_by(Date, Title) %>%
  summarise(`Word Count` = n(), `Avg. Word Length` = mean(word_length)) %>%
  drop_na() %>%
  ungroup %>%
  gather(key = Key, value = Value, -Date, -Title) %>%
  mutate(Date = as.numeric(str_replace(Date, "-", ".")))

tidy_conference_distr %>%
  ggplot(aes(Date, Value)) +
  geom_jitter(width = .25, pch = 21) +
  facet_grid(Key ~ ., scales = "free") +
  theme_bw() +
  theme(axis.title.y = element_blank()) +
  ggtitle("LDS General Conference")

#ggsave("General Conference Talk Word Count and Length Jitter.jpg", width = 7, height = 5, units = "in", dpi = 300)
```

What are the longest General Conference Talks?
```{r}
tidy_conference_distr %>%
  top_n(10, Value) %>%
  select(-Key) %>%
  rename(`Word Count` = Value) %>%
  dplyr::arrange(desc(`Word Count`))
```

What talks have the longest average word length? 

```{r}
tidy_conference_distr %>%
  filter(Key == "Avg. Word Length") %>%
  top_n(10, Value) %>%
  select(-Key) %>%
  rename(`Avg. Word Length` = Value) %>%
  dplyr::arrange(desc(`Avg. Word Length`))
```

What are the longest words used in General Conference?
Elder Ballard ended a 25 year tie for longest word in 2012 with the 22-charactor word "deinstitutionalization."

```{r}
tidy_conference_all %>%
  mutate(`Word Length` = str_length(word)) %>%
  top_n(10, `Word Length`) %>%
  arrange(desc(`Word Length`)) %>%
  select(word, `Word Length`, Author, Title, Date)
```

