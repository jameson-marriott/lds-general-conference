---
title: "LDS Text Analysis"
author: "Jameson Marriott"
output:
  html_document:
    code_folding: hide
---

This notebook is for trying out some text analysis on general conference talks from lds.org. 

```{r startup, include=FALSE}
library(tidyverse)
library(stringr)
library(tidytext)
library(rvest)
library(furrr)
library(svMisc)
```

```{r download}
conference_year_links <- read_html("https://www.lds.org/general-conference/conferences?lang=eng") %>%
  html_nodes(".year-line__link") %>%
  html_attr("href") %>%
  str_c("https://www.lds.org", ., sep = "")
#head(conference_year_links)

# Pull down all the pages that list the conference talks during that year-month
conference_year_pages <- conference_year_links %>%
  future_map(read_html)
#head(conference_year_pages)
```

```{r prepare}
# Get the links to the individual talks
conference_talk_links <- conference_year_pages %>%
  future_map(html_nodes, css = ".lumen-tile__link") %>%
  future_map(html_attr, name = "href") %>%
  future_map( ~ paste0("https://www.lds.org", .)) %>% # This puts link in the empty last spot
  flatten_chr()
conference_talk_links <- conference_talk_links[1:length(conference_talk_links) - 1] # this removes the last link
#head(conference_talk_links)

# Get the titles of the individual talks
conference_talk_titles <- conference_year_pages %>%
  future_map(html_nodes, css = "div.lumen-tile__title") %>%
  #map(html_children) %>% # Not all titles have children, so this skips some of them
  future_map(html_text) %>%
  future_map(str_replace_all, pattern = "[^a-zA-Z0-9\\s:-]|\\t|\\n", replacement = "") %>%
  flatten_chr()
#head(conference_talk_titles)

# Get the authors of the individual talks
conference_talk_authors <- conference_year_pages %>%
  future_map(html_nodes, css = ".lumen-tile__content") %>%
  future_map(html_text) %>%
  flatten_chr()
#head(conference_talk_authors)

# Get the date from the hyperlink
conference_talk_date <- conference_talk_links %>%
  future_map_chr(substr, 40, 46) %>%
  future_map_chr(str_replace, "/", "-")

# Combine the data into a tibble
conference_talks <- tibble(Title = conference_talk_titles,
                           Author = conference_talk_authors,
                           Date = conference_talk_date,
                           Link = conference_talk_links)

#write_csv(conference_talks, "Conference Talks.csv")

#conference_talks <- read_csv("Conference Talks.csv")
```


```{r talk_text_2}
# Initialize tibble
conf_text <- tibble(Link = conference_talks$Link, Text = "")
# Replace the table with a previously saved file if it available
try(
  conf_text <- read_csv("2018-07-01 Conference Talk Text.csv") %>%
    rename(Link = link, Text = text)
)

# Scrape any websites that weren't saved already
for (i in seq_along(conf_text$Link)) {
  progress(i)
  if (is.na(conf_text[i,2]) | conf_text[i,2] == "") {
    conf_text[i,2] = as.character(conf_text[i,1]) %>%
      read_html() %>%
      html_nodes(css = "div.body-block") %>%
      html_text()
    Sys.sleep(sample(seq(1, 3, by=0.001), 1))
  }
  # Print the progress
}

# Write the latest version of the scraped text
 write_csv(conf_text %>% rename(Link = link, Text = text), paste(Sys.Date(), "Conference Talk Text.csv"))

```

```{r load_downloaded_data}
conference_talks <- read_csv("Conference Talks.csv") %>%
  left_join(read_csv("Conference Talk Text.csv") %>% rename(Link = link, Text = text))

```


Who have authored the most conference talks on lds.org?

```{r analyze}
# Who has the most conference talks on lds.org?
conference_authors <- conference_talks %>%
  group_by(Author) %>%
  summarise(`Number of Talks` = n()) %>%
  arrange(desc(`Number of Talks`)) #%>%
  #top_n(12, `Number of Talks`)
conference_authors
```

What are the most common conference talk titles on lds.org, excluding "Statistical Report", etc.?

```{r}
# What are the most common conference talk titles on lds.org?
conference_titles <- conference_talks %>%
  filter(!str_detect(.$Title, pattern = "Church Officers|Report")) %>% # This does remove a few more talks than ideal, but it's pretty close
  #filter(str_detect(.$Title, "Church")) %>% # Just to see what the titles are that contain "church"
  group_by(Title) %>%
  summarise(`Number of Talks` = n()) %>%
  arrange(desc(`Number of Talks`)) #%>%
  #top_n(12, `Number of Talks`)
conference_titles
```

What are the most common words in conference talk titles, once the reports and sustainings have been removed?

```{r}
title_words <- conference_talks %>%
  filter(!str_detect(.$Title, pattern = "Church Officers|Report")) %>% # This does remove a few more talks than ideal, but it's pretty close
  unnest_tokens(word, Title) %>%
  anti_join(stop_words) %>%
  group_by(word) %>%
  summarise(count = n()) %>%
  arrange(desc(count)) %>%
  filter(!str_detect(.$word, "ye")) #%>%
  #top_n(12, count)
title_words

# I still need to pull in the content of the talks, but just downloading that will take some time.
# It would probably be a good idea to only pull down the talks from a couple of authors to start with. 

```

How do the word choices of the three most recent presidents of the LDS church compare? 

```{r}
tidy_conference <- conference_talks %>%
  mutate(Text = str_replace_all(Text, pattern = "[:digit:]|[:punct:]", replacement = " ")) %>%
  unnest_tokens(word, Text) %>%
  anti_join(stop_words)

tidy_presidents <- tidy_conference %>%
  dplyr::filter(Author == "Thomas S. Monson" | Author == "Gordon B. Hinckley" | Author == "Russell M. Nelson")

president_frequency <- tidy_presidents %>%
  count(Author, word) %>%
  group_by(Author) %>%
  mutate(Proportion = n/ sum(n))
president_frequency %>%
  group_by(Author) %>%
  top_n(n = 10, wt = Proportion) %>%
  arrange(Author, desc(Proportion))
  
president_frequency %>%
  group_by(Author) %>%
  top_n(n = 10, wt = Proportion) %>%
  #arrange(desc(Proportion)) %>%
  mutate(word = reorder(as.factor(word), Proportion)) %>%
  ggplot(aes(word, Proportion)) +
  geom_col() +
  ggtitle("Most Used Words from General Conference") +
  facet_grid(.~Author, scales = "free") +
  xlab(NULL) +
  coord_flip() 
  
```

